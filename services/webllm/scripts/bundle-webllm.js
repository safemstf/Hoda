/**
 * Build script to bundle WebLLM for Chrome extension compatibility
 * 
 * Chrome extensions cannot resolve npm module specifiers directly.
 * This script bundles @mlc-ai/web-llm into a single ESM file that
 * can be imported using relative paths.
 * 
 * Usage: npm run build:webllm
 * 
 * @author Arkaan (adapted for extension bundling)
 */

import * as esbuild from 'esbuild';
import { fileURLToPath } from 'url';
import { dirname, join } from 'path';
import { existsSync, readFileSync, statSync } from 'fs';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, '..');

/**
 * Bundle WebLLM library for Chrome extension use
 */
async function bundleWebLLM() {
  console.log('[Bundle] ðŸ“¦ Bundling WebLLM for Chrome extension...');
  console.log('[Bundle] This may take a few moments...\n');

  // Check if WebLLM package exists
  // Note: @mlc-ai/web-llm package uses 'lib/index.js' as its entry point (not 'dist/index.js')
  const webllmPath = join(projectRoot, 'node_modules/@mlc-ai/web-llm/lib/index.js');
  if (!existsSync(webllmPath)) {
    console.error('[Bundle] âŒ Error: @mlc-ai/web-llm package not found');
    console.error(`[Bundle]    Expected at: ${webllmPath}`);
    console.error('[Bundle]    Please run: npm install');
    process.exit(1);
  }

  try {
    const result = await esbuild.build({
      entryPoints: [webllmPath],
      bundle: true,
      format: 'esm',
      platform: 'browser',
      target: 'es2020',
      outfile: join(projectRoot, 'src/bundled-webllm.js'),
      banner: {
        js: `/**
 * Bundled WebLLM library for Chrome extension
 * 
 * This file is auto-generated by scripts/bundle-webllm.js
 * DO NOT EDIT MANUALLY - changes will be overwritten
 * 
 * Source: @mlc-ai/web-llm
 * Bundle time: ${new Date().toISOString()}
 */`
      },
      external: [], // Bundle everything - no external dependencies
      define: {
        'process.env.NODE_ENV': '"production"'
      },
      minify: false, // Keep readable for debugging (can be enabled for production)
      sourcemap: false, // Disable sourcemaps to reduce file size
      logLevel: 'info',
      // Handle browser-specific globals
      inject: [],
      // Ensure proper ES module output
      splitting: false,
      // Tree-shaking enabled by default
      treeShaking: true
    });

    console.log('\n[Bundle] âœ… WebLLM bundled successfully!');
    
    // Get output file info (outfile writes directly to disk, so outputFiles is empty)
    const outputPath = join(projectRoot, 'src/bundled-webllm.js');
    const outputStats = statSync(outputPath);
    const outputSizeKB = (outputStats.size / 1024).toFixed(2);
    
    console.log(`[Bundle]    Output: ${outputPath}`);
    console.log(`[Bundle]    Size: ${outputSizeKB} KB`);
    console.log('\n[Bundle] ðŸ“ Next steps:');
    console.log('   1. The bundled file is ready at: src/bundled-webllm.js');
    console.log('   2. parser.js will automatically use the bundled version');
    console.log('   3. Reload your Chrome extension to test\n');

  } catch (error) {
    console.error('\n[Bundle] âŒ Failed to bundle WebLLM:');
    console.error(`[Bundle]    ${error.message}`);
    
    if (error.errors) {
      error.errors.forEach(err => {
        console.error(`[Bundle]    ${err.text}`);
        if (err.location) {
          console.error(`[Bundle]    at ${err.location.file}:${err.location.line}`);
        }
      });
    }
    
    process.exit(1);
  }
}

// Run the bundling process
bundleWebLLM();
